name: 构建并发布

on:
  push:
    tags:
      - 'v*' # 匹配所有以 v 开头的 tag，包括 v1.0.0, v1.0.0-beta, v1.0.0-rc.1 等

permissions:
  contents: write

jobs:
  build-and-release:
    name: 构建与发布
    runs-on: ubuntu-latest

    steps:
      - name: 检出后端代码
        uses: actions/checkout@v4

      - name: 安装 Go 环境
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          check-latest: true
      
      - name: 获取元数据 (版本号/时间/类型)
        id: meta
        run: |
          # 提取 tag 名称 (例如 v1.0.0 或 v1.1-beta.1)
          VERSION=${GITHUB_REF#refs/tags/}
          
          # 生成构建时间
          BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
          
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=${BUILD_TIME}" >> $GITHUB_OUTPUT
          
          # 判断是否为预发布 (包含 -beta 或 -rc)
          if [[ $VERSION == *"-beta"* ]] || [[ $VERSION == *"-rc"* ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
            echo "Mode: Beta/Pre-release"
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
            echo "Mode: Official Release"
          fi

      - name: 创建构建目录
        run: mkdir -p build_artifacts

      - name: 确定前端目标 Ref
        id: target_frontend
        run: |
          if [[ "${{ steps.meta.outputs.IS_PRERELEASE }}" == "true" ]]; then
            # Beta 模式：强制拉取前端 beta 分支最新代码
            echo "REF=beta" >> $GITHUB_OUTPUT
            echo "Target: Branch 'beta' (Latest HEAD)"
          else
            # 正式模式：强制拉取与后端同名的 Tag
            echo "REF=v${{ steps.meta.outputs.VERSION }}" >> $GITHUB_OUTPUT
            echo "Target: Tag 'v${{ steps.meta.outputs.VERSION }}'"
          fi

      # --- 准备前端资源 ---
      - name: 检出前端仓库
        uses: actions/checkout@v4
        with:
          repository: GoodBoyboy666/PerfectPic-Web
          path: web-source
          ref: ${{ steps.target_frontend.outputs.REF }} # 使用上面动态计算的 Ref

      - name: 安装 pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          cache-dependency-path: web-source/pnpm-lock.yaml

      - name: 提取前端信息并注入变量
        id: fe_build_info
        run: |
          cd web-source
          
          # 获取前端 Commit Hash (用于展示 UI Build 指纹)
          FE_HASH=$(git rev-parse --short HEAD)
          
          echo "FE_HASH=${FE_HASH}" >> $GITHUB_OUTPUT
          
          echo "::group::Frontend Build Info"
          echo "Ref: ${{ steps.target_frontend.outputs.REF }}"
          echo "Commit: ${FE_HASH}"
          echo "::endgroup::"

      - name: 编译前端项目 (注入版本)
        run: |
          cd web-source
          pnpm install
          
          export VITE_APP_VERSION="${{ steps.meta.outputs.VERSION }}"
          export VITE_UI_HASH="${{ steps.fe_build_info.outputs.FE_HASH }}"
          export VITE_BUILD_TIME="${{ steps.meta.outputs.BUILD_TIME }}"
          
          pnpm build

      - name: 嵌入前端资源
        run: |
          # 清理并复制
          rm -rf frontend/*
          cp -r web-source/dist/* frontend/
          touch frontend/.keep

      - name: 准备 Go LDFLAGS
        id: ldflags
        run: |
          VERSION="${{ steps.meta.outputs.VERSION }}"
          TIME="${{ steps.meta.outputs.BUILD_TIME }}"
          COMMIT="${{ github.sha }}"
          FE_HASH="${{ steps.fe_build_info.outputs.FE_HASH }}"
          
          # 构造注入参数 (假设你的变量在 main 包中)
          # 如果你的 main.go 声明的 package 不是 main，请修改下面的 main.AppVersion
          FLAGS="-s -w \
            -X 'main.AppVersion=${VERSION}' \
            -X 'main.BuildTime=${TIME}' \
            -X 'main.GitCommit=${COMMIT}' \
            -X 'main.FrontendVer=${FE_HASH}'"
            
          echo "FLAGS=${FLAGS}" >> $GITHUB_OUTPUT

      - name: 构建 (Linux)
        run: |
          # 1. 纯后端版
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "${{ steps.ldflags.outputs.FLAGS }}" -o build_artifacts/perfect-pic-server-${{ steps.meta.outputs.VERSION }}-linux-amd64 .
          
          # 2. 全栈版 (Embed)
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -tags embed -ldflags "${{ steps.ldflags.outputs.FLAGS }}" -o build_artifacts/perfect-pic-server-${{ steps.meta.outputs.VERSION }}-embed-linux-amd64 .

      - name: 构建 (Windows)
        run: |
          # 1. 纯后端版
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags "${{ steps.ldflags.outputs.FLAGS }}" -o build_artifacts/perfect-pic-server-${{ steps.meta.outputs.VERSION }}-windows-amd64.exe .
          
          # 2. 全栈版 (Embed)
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -tags embed -ldflags "${{ steps.ldflags.outputs.FLAGS }}" -o build_artifacts/perfect-pic-server-${{ steps.meta.outputs.VERSION }}-embed-windows-amd64.exe .

      # --- 上传发布 ---
      - name: 创建 Release 并上传附件
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: build_artifacts/*
          draft: true
          prerelease: ${{ steps.check_prerelease.outputs.IS_PRERELEASE }}
          generate_release_notes: true
